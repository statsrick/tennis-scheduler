<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tennis Doubles Scheduler</title>
  <style>
    :root{
      --court-green:#2c6f2f;
      --form-green:#4CAF50;
      --line:#ffffff;
      --ball:#fffb79;
      --ball-shade:#d6d54f;
    }

    /* Base */
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--court-green);
      color: white;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      position: relative;
    }

    /* Background layers (behind everything, no interaction) */
    .bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }
    
    /* Court lines as an SVG overlay */
    .court {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0.3;
    }
    
    /* Tennis balls with seam pattern */
    .tennis-ball {
      position: absolute;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at 35% 35%, #fcff6c, #d4d645);
      border-radius: 50%;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      opacity: 0.3;
    }
    
    .tennis-ball::before,
    .tennis-ball::after {
      content: '';
      position: absolute;
      border: 2px solid rgba(255,255,255,0.8);
      border-radius: 50%;
    }
    
    .tennis-ball::before {
      width: 36px;
      height: 20px;
      top: -2px;
      left: 0;
      border-bottom: none;
      transform: rotate(-30deg);
    }
    
    .tennis-ball::after {
      width: 36px;
      height: 20px;
      bottom: -2px;
      left: 0;
      border-top: none;
      transform: rotate(-30deg);
    }
    
    .ball-1 { top: 10%; left: 8%; transform: rotate(45deg); }
    .ball-2 { top: 25%; right: 15%; transform: rotate(-20deg); width: 35px; height: 35px; }
    .ball-3 { bottom: 20%; left: 25%; transform: rotate(120deg); }
    .ball-4 { top: 60%; right: 35%; transform: rotate(-60deg); width: 45px; height: 45px; }
    .ball-5 { bottom: 35%; right: 10%; transform: rotate(200deg); width: 38px; height: 38px; }
    .ball-6 { top: 15%; left: 40%; transform: rotate(90deg); }

    /* Foreground content wrapper */
    .content {
      position: relative;
      z-index: 1;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 { 
      text-align: center; 
      margin: 0 0 30px 0; 
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      letter-spacing: 1px;
    }

    h2, h3 {
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .form-container {
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      width: 65%;
      margin-left: auto;
      margin-right: auto;
    }
    
    label { 
      font-size: 1.1em; 
      display: block; 
      margin: 12px 0 6px; 
      font-weight: 500;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    
    input[type="text"], input[type="number"], select {
      width: 100%; 
      padding: 12px; 
      margin: 8px 0;
      font-size: 1em; 
      border-radius: 6px; 
      border: 2px solid transparent;
      box-sizing: border-box; 
      color:#333;
      background: rgba(255,255,255,0.95);
      transition: all 0.3s ease;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: var(--ball);
      box-shadow: 0 0 8px rgba(255,251,121,0.5);
      transform: translateY(-1px);
    }

    /* Buttons */
    .btn-row { 
      display: flex; 
      gap: 15px; 
      margin-top: 20px; 
      justify-content: center;
    }
    
    button {
      font-size: 1.1em; 
      font-weight: 600; 
      border: none;
      border-radius: 8px; 
      padding: 14px 28px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    #runBtn:not([disabled]) {
      background: linear-gradient(135deg, #66bb6a 0%, #4CAF50 100%);
      color: #fff;
    }
    
    #runBtn:not([disabled]):hover { 
      background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    
    #runBtn[disabled] {
      background: linear-gradient(135deg, #8fae90 0%, #7a997b 100%);
      color: #e0e0e0; 
      cursor: not-allowed; 
      opacity: 0.7;
      box-shadow: none;
    }
    
    #resetBtn {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: #fff;
    }
    
    #resetBtn:hover { 
      background: linear-gradient(135deg, #ff8787 0%, #ff6b6b 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    button[type="submit"]:not(#runBtn) {
      background: linear-gradient(135deg, #5c9ead 0%, #4a8b9c 100%);
      color: white;
      padding: 10px 20px;
      margin-top: 10px;
    }

    button[type="submit"]:not(#runBtn):hover {
      background: linear-gradient(135deg, #6fb0c0 0%, #5c9ead 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    .table-container { 
      margin-top: 40px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }
    
    /* Scrollable table wrapper */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    /* Custom scrollbar styling */
    .table-wrapper::-webkit-scrollbar {
      height: 10px;
    }
    
    .table-wrapper::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.5);
      border-radius: 5px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.7);
    }
    
    table { 
      width: 100%; 
      min-width: 600px; /* Ensures table maintains minimum readable width */
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    th, td {
      padding: 12px; 
      text-align: left; 
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-size: 0.95em; 
      color: #333;
    }
    
    th { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.9em;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    
    tr:nth-child(even) { 
      background-color: rgba(76, 175, 80, 0.1);
    }

    tr:hover {
      background-color: rgba(76, 175, 80, 0.2);
      transition: background-color 0.3s ease;
    }
    
    .table-container h2, .table-container h3 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .table-container p {
      color: white;
    }

    .muted { 
      opacity: 0.85; 
      font-style: italic;
      margin-top: 10px;
    }
    
    .error { 
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      color:#fff; 
      padding:12px; 
      border-radius:8px; 
      margin:15px 0; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      font-weight: 500;
    }
    
    .targets-table input[type="number"] {
      width: 100%; 
      padding: 8px; 
      border-radius: 6px; 
      border: 2px solid transparent;
      background: rgba(255,255,255,0.95);
      color:#333;
      transition: all 0.3s ease;
    }

    .targets-table input[type="number"]:focus {
      outline: none;
      border-color: var(--ball);
      box-shadow: 0 0 8px rgba(255,251,121,0.5);
    }

    #targets_block {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
    }

    #totals_line {
      font-weight: 600;
      font-size: 1.05em;
      color: var(--ball);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .download-form {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
    }

    /* Loading overlay */
    #loading {
      position: fixed; 
      inset: 0; 
      display: none; 
      align-items: center; 
      justify-content: center;
      background: rgba(0,0,0,0.7); 
      z-index: 9999;
      font-size: 1.3em; 
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .spinner {
      border: 6px solid rgba(255,255,255,0.3); 
      border-top: 6px solid var(--ball); 
      border-radius: 50%;
      width: 60px; 
      height: 60px; 
      animation: spin 1s linear infinite; 
      margin: 20px auto;
      box-shadow: 0 0 20px rgba(255,251,121,0.5);
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }

    /* Responsive */
    @media (max-width: 900px){
      .form-container { 
        width: 90%; 
      }
      h1 {
        font-size: 2em;
      }
      .content {
        padding: 20px;
      }
    }

    @media (max-width: 600px){
      .form-container { 
        width: 100%; 
      }
      h1 {
        font-size: 1.8em;
      }
      button {
        padding: 12px 20px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>

<!-- Background layers -->
<div class="bg" aria-hidden="true">
  <!-- Court lines (tennis court layout) -->
  <svg class="court" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
    <!-- Outer court rectangle -->
    <rect x="5" y="10" width="90" height="80" fill="none" stroke="white" stroke-width="2.5"/>
    
    <!-- Singles sidelines -->
    <line x1="17" y1="10" x2="17" y2="90" stroke="white" stroke-width="2"/>
    <line x1="83" y1="10" x2="83" y2="90" stroke="white" stroke-width="2"/>
    
    <!-- Service lines -->
    <line x1="17" y1="35" x2="83" y2="35" stroke="white" stroke-width="2"/>
    <line x1="17" y1="65" x2="83" y2="65" stroke="white" stroke-width="2"/>
    
    <!-- Center service line -->
    <line x1="50" y1="35" x2="50" y2="65" stroke="white" stroke-width="2"/>
    
    <!-- Net (center line) -->
    <line x1="5" y1="50" x2="95" y2="50" stroke="white" stroke-width="3" stroke-dasharray="2,1" opacity="0.8"/>
    
    <!-- Center marks on baselines -->
    <line x1="50" y1="10" x2="50" y2="13" stroke="white" stroke-width="2"/>
    <line x1="50" y1="87" x2="50" y2="90" stroke="white" stroke-width="2"/>
  </svg>

  <!-- Tennis balls with seam pattern -->
  <div class="tennis-ball ball-1"></div>
  <div class="tennis-ball ball-2"></div>
  <div class="tennis-ball ball-3"></div>
  <div class="tennis-ball ball-4"></div>
  <div class="tennis-ball ball-5"></div>
  <div class="tennis-ball ball-6"></div>
</div>

<!-- Foreground content -->
<div class="content">
  <h1>ðŸŽ¾ Tennis Doubles Scheduler ðŸŽ¾</h1>

  <div id="loading">
    <div>
      <div class="spinner"></div>
      <div>Running optimizerâ€¦</div>
    </div>
  </div>

  <form class="form-container" method="POST" id="mainForm" action="/">
    {% if error %}<div class="error">{{ error }}</div>{% endif %}

    <label for="num_weeks">1) Number of weeks:</label>
    <input type="number" id="num_weeks" name="num_weeks" min="1" value="{{ M if M else '' }}" required>

    <label for="player_names">2) Player names (comma-separated):</label>
    <input type="text" id="player_names" name="player_names"
           value="{{ player_names | join(', ') if player_names else '' }}"
           placeholder="e.g., megan, su, colleen, shelley, melissa, cindy" required>

    <div id="targets_block">
      <label>3) Targets (weeks per player)</label>
      <table class="targets-table">
        <thead><tr><th style="width:60%;">Player</th><th>Target weeks</th></tr></thead>
        <tbody id="targets_rows">
          {% if player_names %}
            {% for name in player_names %}
              <tr>
                <td class="player-cell">{{ name|trim }}</td>
                <td>
                  <!-- Visible input named with TRIMMED player name -->
                  <input type="number" min="0" step="1"
                         name="{{ name|trim }}" class="target-input"
                         value="{% if custom_targets %}{{ '%.0f'|format(custom_targets.get(name|trim, 0)) }}{% else %}0{% endif %}"
                         data-index="{{ loop.index0 }}"
                         max="{{ M if M else '' }}"
                         oninput="mirrorAndUpdate(this)">
                  <!-- Hidden mirror by index -->
                  <input type="hidden" name="t_{{ loop.index0 }}"
                         value="{% if custom_targets %}{{ '%.0f'|format(custom_targets.get(name|trim, 0)) }}{% else %}0{% endif %}">
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
      <div class="muted">
        Max slots = 4 Ã— weeks. The sum of all targets cannot exceed this. Each player's max is the number of weeks.
      </div>
      <div id="totals_line">
        Total: <span id="total_now">0</span> / <span id="max_slots">0</span>
      </div>
    </div>

    <div class="btn-row">
      <button type="submit" id="runBtn">4) Run Model</button>
      <button type="button" id="resetBtn" onclick="resetAll()">Reset</button>
    </div>
  </form>

  {% if counts %}
  <div class="table-container">
    <h2>Current Counts</h2>
    <div class="table-wrapper">
      <table>
        <thead><tr><th>Player</th><th>Count</th><th>Deviation</th></tr></thead>
        <tbody>
          {# ENSURE the order matches Targets: iterate player_names, look up counts/deviation #}
          {% for name in player_names %}
          <tr>
            <td>{{ name }}</td>
            <td>{{ counts.get(name, 0) }}</td>
            <td>{{ '%.2f'|format(deviation.get(name, 0)) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="muted">Objective value: {{ obj_val }}</p>
    <p class="muted">Adjust targets above and click "Run Model" again to iterate.</p>
  </div>
  {% endif %}

  {% if schedule_data %}
  <div class="table-container">
    <h2>Generated Weekly Schedule</h2>
    <div class="table-wrapper">
      <table>
        <tr>
          <th>Player</th>
          {% for week_num in range(M) %}
            <th>Week {{ week_num + 1 }}</th>
          {% endfor %}
        </tr>
        <tr>
          <td>Player 1</td>
          {% for week in schedule_data %}
            <td>{{ week[0] }}</td>
          {% endfor %}
        </tr>
        <tr>
          <td>Player 2</td>
          {% for week in schedule_data %}
            <td>{{ week[1] }}</td>
          {% endfor %}
        </tr>
        <tr>
          <td>Player 3</td>
          {% for week in schedule_data %}
            <td>{{ week[2] }}</td>
          {% endfor %}
        </tr>
        <tr>
          <td>Player 4</td>
          {% for week in schedule_data %}
            <td>{{ week[3] }}</td>
          {% endfor %}
        </tr>
      </table>
    </div>

    <h3>Download the Schedule</h3>
    <form class="download-form" action="/download" method="POST" id="downloadForm">
      <input type="hidden" name="player_names" value="{{ player_names | join(',') }}">
      <input type="hidden" name="num_weeks" value="{{ M }}">
      <label for="file_format">Choose file format:</label>
      <select name="file_format" id="file_format">
        <!-- Excel first (default) -->
        <option value="xls">Excel (XLSX)</option>
        <option value="csv">CSV</option>
        <option value="pdf">PDF</option>
      </select>
      <!-- targets get mirrored here on submit -->
      <div id="dlTargets"></div>
      <button type="submit">Download Schedule</button>
    </form>
  </div>
  {% endif %}
</div> <!-- /content -->

<script>
  const form       = document.getElementById('mainForm');
  const namesField = document.getElementById('player_names');
  const weeksField = document.getElementById('num_weeks');
  const rowsBody   = document.getElementById('targets_rows');
  const totalNow   = document.getElementById('total_now');
  const maxSlotsEl = document.getElementById('max_slots');
  const runBtn     = document.getElementById('runBtn');
  const loading    = document.getElementById('loading');
  const dlForm     = document.getElementById('downloadForm');

  /* ===== Helpers ===== */

  function parseNames() {
    const raw = namesField.value.trim();
    if (!raw) return [];
    return raw.split(',').map(s => s.trim()).filter(Boolean);
  }

  // Uniform integer split of 4*M across N players (remainder goes to first players)
  function uniformDefaults(M, names) {
    const total = 4 * M;
    const N = Math.max(names.length, 1);
    const base = Math.floor(total / N);
    let rem = total % N;
    return names.map((_, i) => base + (i < rem ? 1 : 0));
  }

  // Cap a single input to weeks M
  function clampToWeeks(el){
    const M = parseInt(weeksField.value || '0', 10);
    if (!M) return;
    el.max = String(M);
    let v = parseInt(el.value || '0', 10);
    if (isNaN(v)) v = 0;
    if (v > M) el.value = M;
    if (v < 0) el.value = 0;
  }

  function mirrorAndUpdate(el) {
    clampToWeeks(el);  // enforce per-player cap on every edit
    // Sync hidden t_i mirror for this input
    const idx = el.getAttribute('data-index');
    const hidden = rowsBody.querySelector(`input[type="hidden"][name="t_${idx}"]`);
    if (hidden) hidden.value = el.value;
    updateTotals();
  }

  function mirrorAllHidden() {
    // Ensure every visible input has a mirrored hidden t_i updated with current value
    rowsBody.querySelectorAll('tr').forEach((tr, i) => {
      const inp = tr.querySelector('.target-input');
      if (!inp) return;
      clampToWeeks(inp); // enforce cap before submit
      // Enforce visible input's name = trimmed player cell text
      const nameCell = tr.querySelector('.player-cell');
      if (nameCell) {
        const trimmed = nameCell.textContent.trim();
        if (trimmed) inp.name = trimmed;
      }
      // Update/create hidden t_i
      let hidden = tr.querySelector(`input[type="hidden"][name="t_${i}"]`);
      if (!hidden) {
        hidden = document.createElement('input');
        hidden.type = 'hidden'; hidden.name = `t_${i}`;
        tr.children[1].appendChild(hidden);
      }
      hidden.value = inp.value;
      // Keep proper index for later edits
      inp.setAttribute('data-index', String(i));
    });
  }

  function rebuildTargetRows(prefill) {
    const names = parseNames();
    const M = parseInt(weeksField.value || '0', 10) || 0;
    rowsBody.innerHTML = '';
    names.forEach((name, i) => {
      const tr  = document.createElement('tr');

      const tdN = document.createElement('td');
      tdN.className = 'player-cell';
      tdN.textContent = name.trim();

      const tdV = document.createElement('td');

      const inp = document.createElement('input');
      inp.type  = 'number';
      inp.min   = '0';
      inp.step  = '1';
      inp.name  = name.trim();     // visible input named with trimmed player name
      inp.className = 'target-input';

      const proposed = prefill ? Number(prefill[i] || 0) : 0;
      inp.value = Math.min(proposed, M);  // clamp initial value to M
      inp.max   = String(M);              // HTML max

      inp.setAttribute('data-index', String(i));
      inp.addEventListener('input', () => mirrorAndUpdate(inp));

      const hidden = document.createElement('input');
      hidden.type  = 'hidden';
      hidden.name  = `t_${i}`;     // mirrored hidden by index
      hidden.value = inp.value;

      tdV.appendChild(inp);
      tdV.appendChild(hidden);

      tr.appendChild(tdN);
      tr.appendChild(tdV);
      rowsBody.appendChild(tr);
    });
  }

  function updateTotals() {
    const M = parseInt(weeksField.value || '0', 10);
    const max = 4 * (isNaN(M) ? 0 : M);
    if (maxSlotsEl) maxSlotsEl.textContent = max;

    let total = 0;
    rowsBody.querySelectorAll('.target-input').forEach(inp => {
      clampToWeeks(inp); // ensure all inputs obey current M while summing
      const v = parseFloat(inp.value);
      if (!isNaN(v)) total += v;
    });
    if (totalNow) totalNow.textContent = total;

    // Disable/enable run button based on total
    if (runBtn) runBtn.disabled = total > max;
  }

  function buildDefaultsIfNeeded(force = false) {
    const names = parseNames();
    const M = parseInt(weeksField.value || '0', 10);

    if (!names.length || !M) {
      rowsBody.innerHTML = '';
      updateTotals();
      return;
    }

    // If existing rows don't match names, rebuild
    const rowCount = rowsBody.querySelectorAll('tr').length;
    const mustRebuild = (rowCount !== names.length);

    // Detect if there are any non-zero values (to avoid clobbering user inputs on initial render)
    const hasValues = Array.from(rowsBody.querySelectorAll('.target-input'))
      .some(inp => inp.value && inp.value !== '0');

    if (force || mustRebuild || !hasValues) {
      const defaults = uniformDefaults(M, names);
      rebuildTargetRows(defaults);
    } else {
      // M might have changed; update max on existing inputs and clamp
      rowsBody.querySelectorAll('.target-input').forEach(inp => clampToWeeks(inp));
    }
    updateTotals();
  }

  function normalizePlayersField() {
    // Keep the posted player_names clean/trimmed
    const names = parseNames();
    namesField.value = names.join(', ');
  }

  function resetAll() {
    // Reload to a clean GET (clears previous results/sections)
    window.location.href = '/';
  }

  // Inject current targets into download form before submitting it
  if (dlForm) {
    dlForm.addEventListener('submit', () => {
      const holder = document.getElementById('dlTargets');
      holder.innerHTML = '';
      document.querySelectorAll('#targets_rows .target-input').forEach((inp, i) => {
        clampToWeeks(inp); // enforce cap before download
        const nameCell = inp.closest('tr').querySelector('.player-cell');
        const player = nameCell ? nameCell.textContent.trim() : `p_${i}`;

        const hByName = document.createElement('input');
        hByName.type = 'hidden';
        hByName.name = player;
        hByName.value = inp.value || 0;

        const hByIdx = document.createElement('input');
        hByIdx.type = 'hidden';
        hByIdx.name = `t_${i}`;
        hByIdx.value = inp.value || 0;

        holder.appendChild(hByName);
        holder.appendChild(hByIdx);
      });
    });
  }

  /* ===== Wire up events ===== */

  // Rebuild defaults when names are actively edited (add/remove/change) or weeks change
  namesField.addEventListener('input',  () => buildDefaultsIfNeeded(true));
  namesField.addEventListener('change', () => buildDefaultsIfNeeded(true));
  namesField.addEventListener('blur',   () => buildDefaultsIfNeeded(true));
  weeksField.addEventListener('input',  () => {
    buildDefaultsIfNeeded(true);
    // also clamp all existing inputs if not rebuilt
    document.querySelectorAll('.target-input').forEach(clampToWeeks);
    updateTotals();
  });

  // Before submit: sync mirrors, validate, normalize names; show loading
  const formEl = document.getElementById('mainForm');
  formEl.addEventListener('submit', (e) => {
    mirrorAllHidden();
    normalizePlayersField();

    // Final guard: prevent submit if total > max
    const M = parseInt(weeksField.value || '0', 10);
    const max = 4 * (isNaN(M) ? 0 : M);
    let total = 0;
    rowsBody.querySelectorAll('.target-input').forEach(inp => {
      clampToWeeks(inp); // enforce cap before submit
      const v = parseFloat(inp.value);
      if (!isNaN(v)) total += v;
    });
    if (total > max) {
      e.preventDefault();
      alert(`Total target (${total}) exceeds maximum ${max} (4 Ã— ${M}). Reduce some values.`);
      return false;
    }

    // Show loading overlay
    loading.style.display = 'flex';
    runBtn.disabled = true;
    return true;
  });

  // On first load, if server rendered rows, recompute totals and ensure mirrors are present
  document.addEventListener('DOMContentLoaded', () => {
    if (rowsBody.children.length > 0) {
      // Enforce visible input name equals trimmed player cell, set max, and ensure hidden mirrors
      rowsBody.querySelectorAll('tr').forEach((tr, i) => {
        const nameCell = tr.querySelector('.player-cell');
        const trimmed  = nameCell ? nameCell.textContent.trim() : '';
        const inp      = tr.querySelector('.target-input');
        if (inp) {
          if (trimmed) inp.name = trimmed;
          inp.setAttribute('data-index', String(i));
          clampToWeeks(inp); // set max and clamp
          let hidden = tr.querySelector(`input[type="hidden"][name="t_${i}"]`);
          if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = `t_${i}`;
            hidden.value = inp.value;
            tr.children[1].appendChild(hidden);
          }
        }
      });
      // Update Max and totals
      const M = parseInt(weeksField.value || '0', 10);
      if (maxSlotsEl) maxSlotsEl.textContent = isNaN(M) ? 0 : (4 * M);
      updateTotals();
    } else {
      buildDefaultsIfNeeded(true);
    }
  });
</script>
</body>
</html>